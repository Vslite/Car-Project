<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Car Configurator Pro</title>
    
    <style>
        :root {
            --primary-blue: #007bff;
            --glass-bg: rgba(0, 0, 0, 0.75);
        }

        html, body { 
            margin: 0; 
            height: 100%; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
        }

        #container { 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1; 
        }

        /* Fixed UI Layer - Always on Top */
        .ui-layer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none; /* Let touches pass through to AR */
            padding-bottom: env(safe-area-inset-bottom, 30px);
        }

        /* Re-enable pointer events for buttons */
        #swap-btn, #color-selector {
            pointer-events: auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #swap-btn {
            padding: 18px 40px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 25px rgba(0, 123, 255, 0.4);
            display: none; /* Shown via JS */
            margin-bottom: 20px;
        }

        #swap-btn:active {
            transform: scale(0.95);
        }

        #color-selector {
            display: none; /* Shown in floor mode */
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 15px 25px;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .color-option {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .color-option.selected {
            border-color: var(--primary-blue);
            transform: scale(1.1);
        }

        /* Color Values */
        #color-white { background: #ffffff; }
        #color-red   { background: #cc0000; }
        #color-blue  { background: #0033aa; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>

    <div class="ui-layer">
        <button id="swap-btn">Place Car on Floor</button>

        <div id="color-selector">
            <div id="color-white" class="color-option selected" data-variant="WhitePaint"></div>
            <div id="color-red" class="color-option" data-variant="RedPaint"></div>
            <div id="color-blue" class="color-option" data-variant="BluePaint"></div>
        </div>
    </div>
    
    <div id="container"></div>

    <model-viewer id="floor-model" 
        ar 
        ar-modes="webxr scene-viewer" 
        src="./models/White.glb" 
        camera-controls 
        shadow-intensity="1" 
        environment-image="neutral"
        style="display: none; width: 100%; height: 100%; position: absolute; top:0; z-index: 2;">
    </model-viewer>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        async function startAR() {
            const mindarThree = new MindARThree({
                container: document.querySelector('#container'),
                imageTargetSrc: './targets.mind'
            });

            const { renderer, scene, camera } = mindarThree;

            // Lighting setup for image tracking mode
            scene.add(new THREE.AmbientLight(0xffffff, 1.0));
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(1, 10, 1);
            scene.add(sun);

            const anchor = mindarThree.addAnchor(0);
            const loader = new GLTFLoader();

            // Load car for the Image Card
            loader.load('./models/White.glb', (gltf) => {
                const car = gltf.scene;
                car.scale.set(0.1, 0.1, 0.1); 
                car.rotation.x = Math.PI / 2; 
                anchor.group.add(car);
            });

            const swapBtn = document.querySelector('#swap-btn');
            const colorSelector = document.querySelector('#color-selector');
            const floorModel = document.querySelector('#floor-model');

            // --- IMAGE TRACKING LOGIC ---
            anchor.onTargetFound = () => {
                swapBtn.style.display = 'block';
            };
            anchor.onTargetLost = () => {
                swapBtn.style.display = 'none';
            };

            // --- TRANSITION LOGIC ---
            swapBtn.addEventListener('click', () => {
                floorModel.activateAR();
            });

            // Handle UI based on AR status
            floorModel.addEventListener('ar-status', (event) => {
                if (event.detail.status === 'entered-ar') {
                    document.getElementById('container').style.visibility = 'hidden';
                    colorSelector.style.display = 'flex';
                    swapBtn.style.display = 'none';
                } else if (event.detail.status === 'exited-ar') {
                    document.getElementById('container').style.visibility = 'visible';
                    colorSelector.style.display = 'none';
                }
            });

            // --- COLOR CONFIGURATION LOGIC ---
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    // UI Polish
                    document.querySelector('.color-option.selected').classList.remove('selected');
                    option.classList.add('selected');

                    // Change Model Viewer Variant
                    const variantName = option.dataset.variant;
                    floorModel.variantName = variantName;
                });
            });

            await mindarThree.start();
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });
        }

        startAR().catch(console.error);
    </script>
</body>
</html>